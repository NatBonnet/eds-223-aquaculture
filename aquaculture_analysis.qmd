---
title: "EDS 223 Homework 4: Determining Suitable Aquaculture EEZ"
author: "Nathalie Bonnet"
date: 2025-11-29
format: html
execute: 
  warning: false
  message: false
---

## README

![](images/README_screenshot.png){fig-align="center"}

## Setup Code

1.  Loading necessary libraries

```{r}
#| output: false
# Read in necessary libraries
library(tidyverse)
library(sf)
library(here)
library(tmap)
library(patchwork)
library(raster)
library(terra)
library(tidyterra)
library(stars)
```

2.  Importing data

```{r}
#| output: false
# Load data in

eez <- read_sf(here("data", "wc_regions_clean.shp"))

depth <- rast(here("data", "depth.tif"))

# Combine sst rasters into a stack
sst <- rast(c((here("data", "average_annual_sst_2008.tif")), 
            (here("data", "average_annual_sst_2009.tif")), 
            (here("data", "average_annual_sst_2010.tif")),
            (here("data", "average_annual_sst_2011.tif")),
            (here("data", "average_annual_sst_2012.tif"))))

```

## Data processing

1.  Check if coordinate reference systems match between datasets, make them all match the exclusive economic zone (eez) data CRS.

```{r}
#| output: false
# Check CRS and fix if no match
if (crs(eez) == crs(depth) &
crs(eez) == crs(sst) &
crs(depth) == crs(sst)){
  print("CRS matches on all data")
} else{
  warning("CRS does not match between all datasets")
  crs(depth) <- crs(eez)
  crs(sst) <- crs(eez)
}
```

2.  Find the mean sea surface temperature (SST) from 2008-2012 on the West Coast.

```{r}
# Create raster of average SST values
mean_sst <- mean(sst)

mean_sst <- mean_sst - 273.15
```

3.  Crop ocean depth data to the same extent as the mean_sst raster.

```{r}
# Crop by the extent of the sst
sst_ext <- ext(mean_sst)

depth_crop <- crop(depth, sst_ext)
```

4.  Check that the spatial resolutions are the same between the bathymetry data and the mean sst data. Resample the depth crop to obtain the same resoluton as the sst and recheck the match.

```{r}
#| output: false
res(depth_crop) == res(mean_sst)

depth_crop_res = resample(depth_crop, mean_sst)

res(depth_crop_res) == res(mean_sst)
```

5.  Intermediate sanity check: if raster layers can stack it confirms that the CRS, extent, and resolution are the same.

```{r}
#| output: false

# Check that bathymetry layer can stack with mean_sst
c(depth_crop_res, mean_sst)
# Works
```

6.  Create reclassification matrices for depth and sst to define areas as suitable or unsuitable for aquaculture of oysters. Apply reclassification matrix to rasters.

```{r}
# Reclassify suitable locations based on parameters

# Create reclassification matrices
sst_rcl <- matrix(c(-Inf, 11, 0,
                  11, 30, 1,
                  30, Inf, 0), 
                  ncol = 3, byrow=TRUE)

depth_rcl <- matrix(c(-Inf, -70, 0,
                  -70, 0, 1,
                  0, Inf, 0), 
                  ncol = 3, byrow=TRUE)

# Reclassify appropriately

sst_reclass <- classify(mean_sst, rcl = sst_rcl)

depth_reclass <- classify(depth_crop_res, rcl = depth_rcl)
```

7.  Multiply depth and sst rasters to return "suitable" only for cells where both depth and temperature are classified as suitable originally.

```{r}
# Multiply rasters to find where suitable conditions overlap
suitable <- sst_reclass*depth_reclass
```

8.  Count the total number of suitable cells by EEZ

```{r}
# Find the total suitable area within each eez

# Mask eez by suitable cells in West Coast region
suitable_eez <- mask(suitable, eez)

# Extract values based on eez zones
zonal <- extract(suitable_eez, eez)

# Return the count of raster cells that are suitable in each eez
zonal_count <- zonal %>% 
  group_by(ID) %>% 
  summarise(count = sum(mean, na.rm = TRUE)) 

# Summary table
kableExtra::kable(zonal_count, caption = "Total count of suitable rasters cells in each West Coast EEZ group", align = "c")
```

9.  Quantify the total area of suitability within each EEZ

```{r}
# Multiply the number of suitable cells by the dimensions of each cell itself to find area
eez_area <- suitable_eez *cellSize(suitable_eez, unit = 'km')

# Pull out values by eez zone 
zonal_area <- extract(eez_area, eez)

# Summarize total area by zone
zonal_area <- zonal_area %>% 
  group_by(ID) %>% 
  summarize(area = sum(mean, na.rm = TRUE)) %>% 
  rename('rgn_id' = ID)

# join area information to eez zone information
eez_zone_areas <- left_join(eez, zonal_area, by = 'rgn_id')
```

10. Map suitable eez output for oysters

```{r}
# Create map with continuous area scale
tm_shape(eez_zone_areas) +
  tm_polygons(fill = 'area',
              fill.scale = tm_scale_continuous(values = "brewer.blues"), 
              fill.legend = tm_legend(title = "suitable area (km^2)")) +
  tm_basemap("Esri.OceanBasemap") +
  tm_title(text = "Total Suitable Area for Oyster Aquaculture by EEZ", width = 10) +
  tm_layout(component.autoscale=FALSE) +
  tm_graticules(alpha = 0.2) +
   tm_basemap("Esri.OceanBasemap") +
  tm_text(text = "rgn", size = 0.4)

# Create subset of data frame to pull out most suitable EEZ
eez_table <- eez_zone_areas %>% 
  select(rgn, area) %>% 
  st_drop_geometry() %>% 
  #rename("Region" = rgn, "Area (km²)" = area) %>% 
  slice_max(area, n=1)

# Print in kable formatting
kableExtra::kable(eez_table, caption = "Most Suitable West Coast EEZ for Oysters", align = "c")
```

## Create generalized function to return the most suitable EEZ on the West Coast and a map of suitable area for specific species.

```{r}
# Generalized function
eez_area_zone <- function(eez_data, depth_data, sst_data, min_temp, max_temp, min_depth, max_depth, species_name){
  
# Make sure all CRSs match with the EEZ data
  if (crs(eez_data) != crs(depth_data) |
crs(eez_data) != crs(sst_data) |
crs(depth_data) != crs(sst_data)){
  crs(depth_data) <- crs(eez_data)
  crs(sst_data) <- crs(eez_data)
}
  
# Find the mean sea surface temperature values and convert to Celsius
  mean_sst <- mean(sst_data)
  
  mean_sst <- mean_sst - 273.15
  
# Crop depth data to the extent of the sea surface temperature data
  # Crop by the extent of the sst
  sst_ext <- ext(mean_sst)

  depth_crop <- crop(depth_data, sst_ext)

# Re sample the depth data to match the resolution of sst data
  depth_crop_res <- resample(depth_crop, mean_sst)

# Create reclassification matrices
  sst_rcl <- matrix(c(-Inf, min_temp, 0,
                  min_temp, max_temp, 1,
                  max_temp, Inf, 0), 
                  ncol = 3, byrow=TRUE)

  depth_rcl <- matrix(c(-Inf, max_depth, 0,
                  max_depth, min_depth, 1,
                  min_depth, Inf, 0), 
                  ncol = 3, byrow=TRUE)

# Reclassify raster data with matrices
  sst_reclass <- classify(mean_sst, rcl = sst_rcl)

  depth_reclass <- classify(depth_crop_res, rcl = depth_rcl)
  
# Find area where there is overlap in suitability
  suitable_cells <- sst_reclass*depth_reclass

# Mask EEZ data by suitable cells in West Coast region
  suitable_eez <- mask(suitable_cells, eez_data)

# Get EEZ data for only suitable EEZ areas
  zonal <- extract(suitable_eez, eez_data)

# Find the suitable area contained by each cell
 eez_area <- suitable_eez *cellSize(suitable_eez, unit = 'km')

# Extract the total area from EEZ zones
 zonal_area <- extract(eez_area, eez_data)
 
# Find the total suitable area in each EEZ zone
  zonal_area <- zonal_area %>% 
  group_by(ID) %>% 
  summarize(area = sum(mean, na.rm = TRUE)) %>% 
  rename('rgn_id' = ID)

# Join EEZ data with suitable area data by region
eez_zone_areas <- left_join(eez_data, zonal_area, by = 'rgn_id')

# Plot the species 
print(
  tm_shape(eez_zone_areas) +
  tm_polygons(fill = 'area',
              fill.scale = tm_scale_continuous(values = "brewer.blues"), 
              fill.legend = tm_legend(title = "suitable area (km²)")) +
  tm_title(text = paste0("Total Suitable Area for ", species_name, " Aquaculture by EEZ"), width = 10) +
  tm_layout(component.autoscale=FALSE) +
  tm_graticules(alpha = 0.2) +
  tm_basemap("Esri.OceanBasemap") +
  tm_text(text = "rgn", size = 0.4)
  )

# Create subset of data frame to pull out most suitable EEZ
eez_table <- eez_zone_areas %>% 
  select(rgn, area) %>% 
  st_drop_geometry() %>% 
  slice_max(area, n=1)


# Print in kable formatting
kableExtra::kable(eez_table, caption = paste0("Most Suitable West Coast EEZ for ", species_name), align = "c")
}
```

Utilize function to check original output from oyster data and generate output for new species of interest.

```{r}
# Compare output from function to original map
eez_area_zone(eez_data = eez, 
              depth_data = depth, 
              sst_data = sst, 
              min_temp = 11,
              max_temp = 30,
              min_depth = 0, 
              max_depth = -70, 
              species_name = "Oyster")
```

```{r}
# Use function for California Yellowstail aquaculture zone
eez_area_zone(eez_data = eez, 
              depth_data = depth, 
              sst_data = sst, 
              min_temp = 18,
              max_temp = 24,
              min_depth = -3, 
              max_depth = -300, 
              species_name = "California Yellowtail")
```

## References

| Data | Citation | Sources |
|-----------------------------|------------------|-------------------------|
| Coral Reef Watch: National Environmental Satellite, Data, and Information Service | *NOAA Coral Reef Watch*. NOAA Coral Reef Watch Daily 5km satellite coral bleaching heat stress SST anomaly product (version 3.1). https://coralreefwatch.noaa.gov/product/5km/index_5km_ssta.php | <https://coralreefwatch.noaa.gov/product/5km/index_5km_ssta.php> |
| General Bathymetric Chart of the Oceans: Global ocean and land terrain models | *Gridded bathymetry data*. GEBCO. https://www.gebco.net/data-products/gridded-bathymetry-data#area | <https://www.gebco.net/data-products/gridded-bathymetry-data#area> |
| Marineregions.org: EEZ boundaries | *EEZ boundaries.* Marine regions. https://www.marineregions.org/eez.php | <https://www.marineregions.org/eez.php> |
